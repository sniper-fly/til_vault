---
tags:
  - ISUCON
---

alpでのjson log分析とabによるベンチマーク
albコマンドでは
sqlでいうgroup by みたいな分析が出来る
```
%> cat logs/nginx/access.log| alp json                                                        [~/study/isucon/private-isu/webapp][][rnakai]
+-------+-----+-----+-----+-----+-----+--------+------------------+-------+-------+-------+-------+-------+-------+-------+--------+-------------+-------------+-------------+-------------+
| COUNT | 1XX | 2XX | 3XX | 4XX | 5XX | METHOD |       URI        |  MIN  |  MAX  |  SUM  |  AVG  |  P90  |  P95  |  P99  | STDDEV |  MIN(BODY)  |  MAX(BODY)  |  SUM(BODY)  |  AVG(BODY)  |
+-------+-----+-----+-----+-----+-----+--------+------------------+-------+-------+-------+-------+-------+-------+-------+--------+-------------+-------------+-------------+-------------+
| 1     | 0   | 1   | 0   | 0   | 0   | GET    | /                | 1.547 | 1.547 | 1.547 | 1.547 | 1.547 | 1.547 | 1.547 | 0.000  | 35266.000   | 35266.000   | 35266.000   | 35266.000   |
| 1     | 0   | 1   | 0   | 0   | 0   | GET    | /image/10000.png | 0.011 | 0.011 | 0.011 | 0.011 | 0.011 | 0.011 | 0.011 | 0.000  | 1056749.000 | 1056749.000 | 1056749.000 | 1056749.000 |
| 1     | 0   | 1   | 0   | 0   | 0   | GET    | /image/9999.jpg  | 0.011 | 0.011 | 0.011 | 0.011 | 0.011 | 0.011 | 0.011 | 0.000  | 89928.000   | 89928.000   | 89928.000   | 89928.000   |
| 1     | 0   | 1   | 0   | 0   | 0   | GET    | /image/9998.jpg  | 0.013 | 0.013 | 0.013 | 0.013 | 0.013 | 0.013 | 0.013 | 0.000  | 61656.000   | 61656.000   | 61656.000   | 61656.000   |
| 1     | 0   | 1   | 0   | 0   | 0   | GET    | /image/9997.jpg  | 0.017 | 0.017 | 0.017 | 0.017 | 0.017 | 0.017 | 0.017 | 0.000  | 176404.000  | 176404.000  | 176404.000  | 176404.000  |

...

```

これを
```
%> cat logs/nginx/access.log| alp json -m="/image/[0-9]+\.jpg"                                                                                                       [~/study/isucon/private-isu/webapp][][rnakai]
+-------+-----+-----+-----+-----+-----+--------+--------------------+-------+-------+-------+-------+-------+-------+-------+--------+-------------+-------------+-------------+-------------+
| COUNT | 1XX | 2XX | 3XX | 4XX | 5XX | METHOD |        URI         |  MIN  |  MAX  |  SUM  |  AVG  |  P90  |  P95  |  P99  | STDDEV |  MIN(BODY)  |  MAX(BODY)  |  SUM(BODY)  |  AVG(BODY)  |
+-------+-----+-----+-----+-----+-----+--------+--------------------+-------+-------+-------+-------+-------+-------+-------+--------+-------------+-------------+-------------+-------------+
| 1     | 0   | 1   | 0   | 0   | 0   | GET    | /                  | 1.547 | 1.547 | 1.547 | 1.547 | 1.547 | 1.547 | 1.547 | 0.000  | 35266.000   | 35266.000   | 35266.000   | 35266.000   |
| 1     | 0   | 1   | 0   | 0   | 0   | GET    | /image/10000.png   | 0.011 | 0.011 | 0.011 | 0.011 | 0.011 | 0.011 | 0.011 | 0.000  | 1056749.000 | 1056749.000 | 1056749.000 | 1056749.000 |
| 19    | 0   | 19  | 0   | 0   | 0   | GET    | /image/[0-9]+\.jpg | 0.004 | 0.021 | 0.215 | 0.011 | 0.020 | 0.021 | 0.021 | 0.004  | 61656.000   | 374805.000  | 2521146.000 | 132691.895  |
+-------+-----+-----+-----+-----+-----+--------+--------------------+-------+-------+-------+-------+-------+-------+-------+--------+-------------+-------------+-------------+-------------+

```
このように正規表現でパスパラメータをまとめられる

```
%> cat logs/nginx/access.log| alp json -m="/image/[0-9]+\.jpg" --sort=avg -r
```
レスポンスタイムの平均の降順

abコマンドによるベンチマーク
http://localhost/ に対して 1 並列（直列）で、合計 10 回のリクエストを送信
```
$ ab -c 1 -n 10 http://localhost/
```

結果
```
Server Software:        nginx/1.26.2
Server Hostname:        localhost
Server Port:            80

Document Path:          /
Document Length:        35266 bytes

Concurrency Level:      1
Time taken for tests:   14.066 seconds
Complete requests:      10
Failed requests:        0
Total transferred:      356290 bytes
HTML transferred:       352660 bytes
Requests per second:    0.71 [#/sec] (mean)
Time per request:       1406.589 [ms] (mean)
Time per request:       1406.589 [ms] (mean, across all concurrent requests)
Transfer rate:          24.74 [Kbytes/sec] received

Connection Times (ms)
              min  mean[+/-sd] median   max
Connect:        0    0   0.0      0       0
Processing:  1396 1407   8.0   1409    1420
Waiting:     1396 1406   7.9   1409    1420
Total:       1396 1407   8.0   1409    1420

```

alpとの比較
```
tail -n 10 logs/nginx/access.log| alp json -o count,method,uri,min,avg,max

+-------+--------+-----+-------+-------+-------+
| COUNT | METHOD | URI |  MIN  |  AVG  |  MAX  |
+-------+--------+-----+-------+-------+-------+
| 10    | GET    | /   | 1.396 | 1.406 | 1.419 |
+-------+--------+-----+-------+-------+-------+
```

ログのローテートを行った後はnginxの再起動を行う
```
nginx -s reopen
```

abの実行、ログのローテート、nginxの再起動などをまとめて出来るスクリプトなどの用意もあり
