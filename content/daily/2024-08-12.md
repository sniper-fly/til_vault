---
tags:
  - daily
---

### 個人開発
tsxでデバッグするには
[VS Code debugging | tsx](https://tsx.is/vscode#setup)
こちらが参考になるが、ローカルで実行していないので微妙に使えない

[Debug an app running in a Docker container](https://code.visualstudio.com/docs/containers/debug-common#_nodejs)
[Build and run a Node.js app in a container](https://code.visualstudio.com/docs/containers/quickstart-node#_debug-in-the-service-container)
vscodeの公式記事
requirements にprelaunch taskとしてdockerコンテナを起動すること、が挙げられている
既に起動しているコンテナのランタイムを利用するやり方はないのか？

アーティスト名が被っていることで、createレコードが失敗しているケースが多い

既存のレコードを全て削除したい

@id を設定しているレコードに@unique は必要？
結論：不要

```
Q. Is it possible to use @unique on id?
No, it is not necessary to use @unique on an id field in Prisma. The @id attribute inherently ensures that the field is unique, as it designates the primary key of the model. Adding @unique to an id field would be redundant.
Here is an example to illustrate this:

model User {
  id    Int     @id @default(autoincrement())
  email String  @unique
  name  String?
}
In this example, the id field is the primary key and is automatically unique due to the @id attribute. The email field is explicitly marked as unique using the @unique attribute.
For more information on defining unique fields and primary keys, you can refer to the Prisma documentation on defining unique fields and records must be uniquely identifiable.
```

```
Can I use createMany and connectOrCreate at the same time?

No, you cannot use `createMany` and `connectOrCreate` at the same time in a top-level query. According to the Prisma documentation and various discussions, you cannot nest `create`, `createMany`, `connect`, or `connectOrCreate` inside a top-level `createMany` query.

Here are some relevant points from the knowledge sources:

1. **Prisma Documentation on `createMany`**:
    
    - "You **cannot** create or connect relations by using nested `create`, `createMany`, `connect`, `connectOrCreate` queries inside a top-level `createMany()` query." [Source](https://www.prisma.io/docs/orm/reference/prisma-client-reference#createmany)
```

connectOrCreateを使って、関連するレコードがDBに存在していた場合は作成しないようにできる
但し複数の関連を一度に作成する場合は使えない

#####  Is it possible to create multiple records by using connectOrCreate in nested writes?
No, it is not currently possible to create multiple records using `connectOrCreate` in nested writes directly. The `connectOrCreate` method is designed to handle a single record at a time.
However, you can achieve this by using a loop to iterate over the records you want to create and applying `connectOrCreate` to each one individually.

##### Example: Using a Loop to Create Multiple Records with `connectOrCreate`
Here is an example of how you can use a loop to create multiple records with `connectOrCreate`:
```ts
const { PrismaClient } = require('@prisma/client');

const prisma = new PrismaClient();

async function createMultipleRecords() {
  const records = [
    { email: 'user1@example.com', name: 'User 1' },
    { email: 'user2@example.com', name: 'User 2' },
    { email: 'user3@example.com', name: 'User 3' },
  ];

  for (const record of records) {
    await prisma.user.upsert({
      where: { email: record.email },
      update: {},
      create: {
        email: record.email,
        name: record.name,
      },
    });
  }
}

createMultipleRecords()
  .catch(e => {
    throw e;
  })
  .finally(async () => {
    await prisma.$disconnect();
  });
```

##### Official Guidance
According to the [official answer](https://github.com/prisma/prisma/discussions/18505) from the Prisma team, an array can be passed in a nested `createMany` call, but not in a nested create query. They recommend invoking a create query inside a loop to create multiple records.

prismaで作成した全てのレコードを削除するには？
##### Using `migrate reset` with Prisma Migrate
If you use Prisma Migrate, you can use the `migrate reset` command. This will drop the database, create a new one, apply migrations, and seed the database with data.
```
prisma migrate reset
```

[Relation queries (Concepts) | Prisma Documentation](https://www.prisma.io/docs/orm/prisma-client/queries/relation-queries#add-new-related-records-to-an-existing-record)
createManyがネストされたオブジェクトの中で使えるのはupdateの中だけ

[How to use connect inside createMany ? · prisma/prisma · Dis...](https://github.com/prisma/prisma/discussions/18963)
createMany 関数の中では、connectは使えない

skipDuplicatesを存分に利用して一度に大量のデータ挿入するのが最もクエリ回数が少なく効率的
その場合、createManyでは関連するテーブルのデータまでまとめて作成ができないため、１種類ずつ、テーブルのクエリを作成する必要がある
多対多のリレーションを表現する場合は中間テーブル(join table)のcreateManyが必要になるが、implicit m-m テーブルは直接のcreateManyができないので、その手法をとる場合はschema.prismaでexplicit m-m テーブルの作成を行う必要がある
ただし今回の場合、自分の環境で一回DBを作れば完了なので、速度はそこまで気にする必要はなさそう
