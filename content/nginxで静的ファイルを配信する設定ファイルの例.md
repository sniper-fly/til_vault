---
tags:
  - nginx
  - ISUCON
---

nginxで静的ファイルを配信する設定ファイルの例
```
 location /image/ {
   root /home/isucon/private_isu/webapp/public/;
   expires 1d;
   try_files $uri @app;
 }
 
 location @app {
   internal;
   proxy_pass http://localhost:8080;
 }
```

このNginx設定では、`/image/`で始まるURLパスに対してのリクエストの処理と、アプリケーション（`@app`）へのプロキシを設定しています。行ごとに詳しく解説します。

### `location /image/ { ... }` (行29-33)

- **29行目: `location /image/ {`**
    
    - `/image/`で始まるURLパスに対しての処理を指定しています。このロケーションブロック内で、リクエストがどのように処理されるかを定義しています。
- **30行目: `root /home/isucon/private_isu/webapp/public/;`**
    
    - このディレクティブは、静的ファイル（画像など）を提供するためのルートディレクトリを指定しています。`/image/`に続くパスは、このディレクトリを基準に解決されます。
    - たとえば、`/image/logo.png` へのリクエストは、Nginxが`/home/isucon/private_isu/webapp/public/image/logo.png`からファイルを探すということです。
- **31行目: `expires 1d;`**
    
    - 画像などの静的コンテンツのキャッシュ期間を指定しています。この場合、`1d`は1日間キャッシュすることを意味します。ブラウザがこのファイルを1日間キャッシュすることで、リクエストが繰り返しサーバーに送られるのを防ぎます。
- **32行目: `try_files $uri @app;`**
    
    - Nginxはまず、リクエストされたファイルが存在するかどうかを`$uri`（リクエストのパスに基づくファイル）で確認します。もしそのファイルが存在しなければ、`@app`という名前のロケーションブロック（行35-38）に処理を引き渡します。

### `location @app { ... }` (行35-38)

- **35行目: `location @app {`**
    
    - この行は、`@app`という名前の内部ロケーションを定義しています。`@app`は外部から直接アクセスできず、内部的にのみ使われます（`try_files`などで使用されます）。
- **36行目: `internal;`**
    
    - このディレクティブは、外部クライアントからの直接のアクセスを禁止します。このロケーションは、内部リクエスト（サーバー内からのリクエスト）専用であることを指定します。
- **37行目: `proxy_pass http://localhost:8080;`**
    
    - リクエストをバックエンドのアプリケーションサーバー（この場合は`localhost:8080`）にプロキシします。つまり、`/image/`に対応する静的ファイルが見つからなかった場合、Nginxはこのリクエストをアプリケーションに転送します。
### 全体の流れ
1. クライアントが`/image/`で始まるURLにリクエストを送る。
2. Nginxは`/home/isucon/private_isu/webapp/public/image/`ディレクトリでリクエストされたファイルを探す。
3. ファイルが見つかれば、そのファイルを返し、クライアントに1日間キャッシュさせる。
4. ファイルが見つからなければ、リクエストを`@app`に転送し、`localhost:8080`のアプリケーションサーバーにプロキシする。